<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>You Are Not Alone — Admin Dashboard</title>

  <link rel="stylesheet" href="admin.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* ADD THESE STYLES FOR THE TAGS AND SETTINGS SECTION */
    .user-tag {
      font-size: 0.8em;
      padding: 2px 6px;
      border-radius: 10px;
      margin-left: 5px;
    }
    
    .user-tag.survivor {
      background-color: #e3f2fd;
      color: #1976d2;
    }
    
    .user-tag.medical {
      background-color: #f3e5f5;
      color: #7b1fa2;
    }
    
    .user-tag.therapist {
      background-color: #e8f5e8;
      color: #388e3c;
    }
    
    .user-tag.legal {
      background-color: #fff3e0;
      color: #f57c00;
    }
    
    .sidebar-settings {
      margin-top: auto;
      padding: 15px;
      border-top: 1px solid #e0e0e0;
      background-color: #f5f5f5;
    }
    
    .platform-info {
      margin-top: 8px;
    }
    
    .platform-name-label {
      font-size: 0.85em;
      color: #666;
    }
    
    .platform-name-value {
      font-weight: bold;
      color: #333;
    }
    
    .chat-item-header {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }
    
    .chat-name {
      font-weight: bold;
      margin-right: 5px;
    }
    
    .chat-time {
      margin-left: auto;
      font-size: 0.8em;
      color: #666;
    }
    
    .chat-preview {
      font-size: 0.9em;
      color: #666;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  </style>
</head>
<body>

<nav class="top-nav" role="banner">
  <div class="left">
    <img src="logo.png" alt="logo" class="logo" />
    <div class="title">
      <h1>You Are Not Alone</h1>
      <p>Admin</p>
    </div>
  </div>
  <div class="center">
    <span class="crisis-label">Crisis 24/7 1-800-656-4673</span>
  </div>
  <div class="right">
    <div class="user-info">
      <p class="user-name">Loading...</p>
      <p class="user-email">Loading...</p>
    </div>
    <button class="signout-btn">Sign Out</button>
  </div>
</nav>
  
<div class="layout">
  <aside class="sidebar" aria-label="Primary navigation">
    <nav class="sidebar-nav">
      <a href="#" class="sidebar-item active"><i class="fa-solid fa-house"></i><span>Dashboard</span></a>
      <a href="#users" class="sidebar-item"><i class="fa-solid fa-users-cog"></i><span>Users</span></a>
      <a href="#appointments" class="sidebar-item"><i class="fa-solid fa-calendar-check"></i><span>Appointments</span></a>
      <a href="#reports" class="sidebar-item"><i class="fa-solid fa-file-lines"></i><span>Reports</span></a>
      <a href="#content" class="sidebar-item"><i class="fa-solid fa-ban"></i><span>Content Moderation</span></a>
      <a href="#resources" class="sidebar-item"><i class="fa-solid fa-file-pdf"></i><span>Resources</span></a>
      <a href="#activity" class="sidebar-item"><i class="fa-solid fa-list"></i><span>Activity Logs</span></a>
      <a href="#messages" class="sidebar-item"><i class="fa-solid fa-message"></i><span>Messages</span></a>
      <a href="#settings" class="sidebar-item"><i class="fa-solid fa-gear"></i><span>Settings</span></a>
    </nav>
  </aside>

  <main class="main" role="main">
    <h1 class="dashboard-title">Admin Dashboard</h1>

    <!-- Stats -->
    <section class="stats">
      <article class="stat-card">
        <div class="stat-icon"><i class="fa-solid fa-users"></i></div>
        <div class="stat-body">
          <div class="stat-value" id="total-users">0</div>
          <div class="stat-label">Total Users</div>
        </div>
      </article>
      <article class="stat-card">
        <div class="stat-icon"><i class="fa-solid fa-calendar-check"></i></div>
        <div class="stat-body">
          <div class="stat-value" id="total-appointments">0</div>
          <div class="stat-label">Appointments</div>
        </div>
      </article>
      <article class="stat-card">
        <div class="stat-icon"><i class="fa-solid fa-file-lines"></i></div>
        <div class="stat-body">
          <div class="stat-value" id="total-reports">0</div>
          <div class="stat-label">Reports</div>
        </div>
      </article>
    </section>

    <!-- Users Table -->
    <section id="users" class="panel">
      <h3>Users</h3>
      <div class="panel-body">
        <table class="table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="users-table">
            <tr><td colspan="5">Loading users...</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Appointments -->
    <section id="appointments" class="panel">
      <h3>Appointments</h3>
      <table class="table">
        <thead>
          <tr><th>User</th><th>Counselor</th><th>Date & Time</th><th>Status</th></tr>
        </thead>
        <tbody id="appointments-table">
          <tr><td colspan="4">Loading appointments...</td></tr>
        </tbody>
      </table>
    </section>

    <!-- Charts -->
    <section id="charts" class="panel">
      <h3>Appointment Stats</h3>
      <canvas id="appointmentsChart" height="150"></canvas>
    </section>

    <!-- Reports -->
    <section id="reports" class="panel">
      <h3>Reports</h3>
      <ul id="reports-list"><li>Loading reports...</li></ul>
    </section>

    <!-- Content Moderation -->
    <section id="content" class="panel">
      <h3>Content Moderation</h3>
      <ul id="flagged-messages"><li>Loading flagged messages...</li></ul>
    </section>

    <!-- Resources -->
    <section id="resources" class="panel">
      <h3>Manage Resources</h3>
      <div>
        <input type="text" id="resource-title" placeholder="Resource Title" />
        <input type="file" id="resource-file" />
        <button id="add-resource-btn" class="btn">Add Resource</button>
      </div>
      <ul id="resources-list"><li>Loading resources...</li></ul>
    </section>

    <!-- Activity Logs -->
    <section id="activity" class="panel">
      <h3>Activity Logs</h3>
      <ul id="activity-log"><li>Loading activity...</li></ul>
    </section>

    <!-- Messages Section -->
    <section id="messages" class="panel">
      <h3>Messages</h3>
      <div class="panel-body">
        <div class="chat-container">
          <!-- Chat Sidebar -->
          <div class="chat-sidebar">
            <div class="chat-list-header">
              <h4>Chats</h4>
              <input type="text" id="search-chats" class="search-chats" placeholder="Search chats...">
            </div>
            <div class="chat-list" id="chat-list">
              <!-- Chat list will be populated by JavaScript -->
              <div class="empty-chat-state">Loading chats...</div>
            </div>
            <div class="start-new-chat">
              <select id="new-chat-select" class="new-chat-select">
                <option value="" disabled selected>Start new chat...</option>
              </select>
            </div>
            
            <!-- Settings section at the bottom -->
            <div class="sidebar-settings">
              <h4>Settings</h4>
              <div class="platform-info">
                <div class="platform-name-label">Platform name</div>
                <div class="platform-name-value">You Are Not Alone</div>
              </div>
            </div>
          </div>
          
          <!-- Chat Main Area -->
          <div class="chat-main">
            <div class="chat-header" id="chat-header" style="display: none;">
              <div class="chat-recipient">
                <div class="chat-recipient-avatar" id="recipient-avatar">U</div>
                <div>
                  <h4 id="recipient-name">User Name</h4>
                  <small id="recipient-status">Online</small>
                </div>
              </div>
            </div>
            
            <div class="chat-messages" id="chat-messages">
              <div class="empty-chat">
                <i class="fa-solid fa-comment-dots"></i>
                <h4>Select a chat to start messaging</h4>
                <p>Choose a user from the list to begin your conversation</p>
              </div>
            </div>
            
            <div class="chat-input-area" id="chat-input-area" style="display: none;">
              <textarea id="chat-message-input" placeholder="Type your message..." rows="1"></textarea>
              <button id="send-message-btn" disabled>Send</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Settings -->
    <section id="settings" class="panel">
      <h3>Settings</h3>
      <div class="panel-body">
        <form class="settings-form">
          <label>Platform name
            <input type="text" value="You Are Not Alone" />
          </label>
          <label>Crisis number
            <input type="text" value="1-800-656-4673" />
          </label>
          <div class="form-actions">
            <button type="submit" class="btn primary">Save Settings</button>
          </div>
        </form>
      </div>
    </section>

    <footer class="dashboard-footer">
      <p class="help-text">You are not alone. Help is available 24/7.</p>
    </footer>
  </main>
</div>

<script type="module">
import { auth, db, storage } from "../firebase.js";
import { logActivity } from "../utils.js";
import {
  collection, addDoc, serverTimestamp, query, orderBy,
  limit, onSnapshot, deleteDoc, doc, updateDoc, getDoc, getDocs, setDoc
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

import {
  ref as storageRef, uploadBytes, getDownloadURL
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";


// ---------------- UI Elements ----------------
const userNameEl = document.querySelector(".user-name");
const userEmailEl = document.querySelector(".user-email");
userNameEl.textContent = "Loading...";
userEmailEl.textContent = "Loading...";

let currentUser = null;
let currentUserData = null;


// ---------------- Load Admin ----------------
async function loadAdmin(user) {
  const userRef = doc(db, "users", user.uid);
  const snapshot = await getDoc(userRef);

  if (!snapshot.exists()) {
    alert("Admin profile not found.");
    await signOut(auth);
    return (window.location.href = "../auth/login.html");
  }

  const data = snapshot.data();
  if (data.role.toLowerCase() !== "admin") {
    alert("Unauthorized access.");
    redirectToCorrectDashboard(data.role);
    return null;
  }

  userNameEl.textContent = data.fullname;
  userEmailEl.textContent = data.email;
  currentUserData = data;
  return data;
}


// ---------------- Redirect ----------------
function redirectToCorrectDashboard(role) {
  switch (role.toLowerCase()) {
    case "survivor":
    case "anonymous":
      window.location.href = "../survivor/survivor.html";
      break;
    case "medical":
      window.location.href = "../medical/medical.html";
      break;
    case "legal":
      window.location.href = "../legal/legal.html";
      break;
    case "therapist":
      window.location.href = "../therapist/therapist.html";
      break;
    default:
      window.location.href = "../auth/login.html";
  }
}


// ---------------- Sign Out ----------------
document.querySelector(".signout-btn").onclick = async () => {
  await signOut(auth);
  window.location.href = "../auth/login.html";
};


// ---------------- Users ----------------
function loadUsersRealtime() {
  const usersTable = document.getElementById("users-table");
  const usersRef = collection(db, "users");

  onSnapshot(usersRef, snapshot => {
    usersTable.innerHTML = "";

    if (snapshot.empty) {
      usersTable.innerHTML = "<tr><td colspan='5'>No users found</td></tr>";
      return;
    }

    snapshot.forEach(docSnap => {
      const user = docSnap.data();
      const userId = docSnap.id;

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${user.fullname || "N/A"}</td>
        <td>${user.email || "N/A"}</td>
        <td>
          <select class="role-select" data-id="${userId}">
            <option value="survivor" ${user.role === "survivor" ? "selected" : ""}>Survivor</option>
            <option value="therapist" ${user.role === "therapist" ? "selected" : ""}>Therapist</option>
            <option value="medical" ${user.role === "medical" ? "selected" : ""}>Medical Practitioner</option>
            <option value="legal" ${user.role === "legal" ? "selected" : ""}>Legal Representative</option>
            <option value="admin" ${user.role === "admin" ? "selected" : ""}>Admin</option>
          </select>
        </td>
        <td>
          <select class="status-select" data-id="${userId}">
            <option value="active" ${user.status === "active" ? "selected" : ""}>Active</option>
            <option value="pending" ${user.status === "pending" ? "selected" : ""}>Pending</option>
            <option value="suspended" ${user.status === "suspended" ? "selected" : ""}>Suspended</option>
            <option value="banned" ${user.status === "banned" ? "selected" : ""}>Banned</option>
            <option value="denied" ${user.status === "denied" ? "selected" : ""}>Denied</option>
          </select>
        </td>
        <td>
          <button class="delete-user-btn" data-id="${userId}" data-email="${user.email}">Delete</button>
          <button class="ban-user-btn" data-id="${userId}" data-email="${user.email}">Ban</button>
        </td>
      `;

      usersTable.appendChild(row);
    });

    setupUserActionListeners();
  });
}


// ---------------- FIX: AUTH WRAPPED LISTENERS ----------------
function setupUserActionListeners() {
  onAuthStateChanged(auth, admin => {
    if (!admin) return;

    // Delete user
    document.querySelectorAll(".delete-user-btn").forEach(btn => {
      btn.onclick = async () => {
        if (!confirm(`Delete user: ${btn.dataset.email}?`)) return;

        await deleteDoc(doc(db, "users", btn.dataset.id));
        await logActivity(admin.uid, "Deleted user", btn.dataset.email, "admin");
      };
    });

    // Change role
    document.querySelectorAll(".role-select").forEach(select => {
      select.onchange = async () => {
        await updateDoc(doc(db, "users", select.dataset.id), {
          role: select.value
        });

        await logActivity(
          admin.uid,
          "Changed role",
          `UserID=${select.dataset.id} → ${select.value}`,
          "admin"
        );
      };
    });

    // Change status
    document.querySelectorAll(".status-select").forEach(select => {
      select.onchange = async () => {
        await updateDoc(doc(db, "users", select.dataset.id), {
          status: select.value
        });

        await logActivity(
          admin.uid,
          "Updated status",
          `UserID=${select.dataset.id} → ${select.value}`,
          "admin"
        );
      };
    });

    // Ban user
    document.querySelectorAll(".ban-user-btn").forEach(btn => {
      btn.onclick = async () => {
        await updateDoc(doc(db, "users", btn.dataset.id), { status: "banned" });
        await logActivity(admin.uid, "Banned user", btn.dataset.email, "admin");
      };
    });
  });
}


// ---------------- Activity Logs ----------------
function loadActivityLogs() {
  const logsEl = document.getElementById("activity-log");
  const q = query(collection(db, "activityLogs"), orderBy("timestamp", "desc"), limit(100));

  onSnapshot(q, snapshot => {
    logsEl.innerHTML = "";

    if (snapshot.empty) {
      logsEl.innerHTML = "<li>No activity yet</li>";
      return;
    }

    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const time = data.timestamp?.toDate().toLocaleString() || "Unknown";

      logsEl.innerHTML += `
        <li>[${time}] [${data.userRole?.toUpperCase() || "N/A"}] ${data.action}
        ${data.target ? "— " + data.target : ""}</li>
      `;
    });
  });
}


// ---------------- Flagged Messages ----------------
function loadFlaggedMessages() {
  const flaggedEl = document.getElementById("flagged-messages");

  onSnapshot(collection(db, "flaggedMessages"), snapshot => {
    flaggedEl.innerHTML = "";

    snapshot.forEach(docSnap => {
      const msg = docSnap.data();

      const li = document.createElement("li");
      li.innerHTML = `
        <strong>${msg.userEmail}</strong>: ${msg.text}
        <button class="remove-msg-btn" data-id="${docSnap.id}">Remove</button>
        <button class="warn-user-btn" data-user="${msg.userId}">Warn</button>
        <button class="suspend-user-btn" data-user="${msg.userId}">Suspend</button>
      `;
      flaggedEl.appendChild(li);
    });

    setupFlaggedActions();
  });
}


// ---------------- FIXED: AUTH WRAPPED ----------------
function setupFlaggedActions() {
  onAuthStateChanged(auth, admin => {
    if (!admin) return;

    document.querySelectorAll(".remove-msg-btn").forEach(btn => {
      btn.onclick = async () => {
        await deleteDoc(doc(db, "flaggedMessages", btn.dataset.id));
        await logActivity(admin.uid, "Removed flagged message", btn.dataset.id, "admin");
      };
    });

    document.querySelectorAll(".warn-user-btn").forEach(btn => {
      btn.onclick = async () => {
        await logActivity(admin.uid, "Warned user", btn.dataset.user, "admin");
        alert("User warned.");
      };
    });

    document.querySelectorAll(".suspend-user-btn").forEach(btn => {
      btn.onclick = async () => {
        await updateDoc(doc(db, "users", btn.dataset.user), { status: "suspended" });
        await logActivity(admin.uid, "Suspended user", btn.dataset.user, "admin");
      };
    });
  });
}


// ---------------- Resources ----------------
function loadResources() {
  const resourcesEl = document.getElementById("resources-list");

  onSnapshot(collection(db, "resources"), snapshot => {
    resourcesEl.innerHTML = "";

    snapshot.forEach(docSnap => {
      const res = docSnap.data();

      const li = document.createElement("li");
      li.innerHTML = `
        ${res.title}
        <button class="edit-res-btn" data-id="${docSnap.id}">Edit</button>
        <button class="delete-res-btn" data-id="${docSnap.id}">Delete</button>
      `;
      resourcesEl.appendChild(li);
    });

    setupResourceActions();
  });
}


// ---------------- FIXED: AUTH WRAPPED ----------------
function setupResourceActions() {
  onAuthStateChanged(auth, admin => {
    if (!admin) return;

    document.querySelectorAll(".delete-res-btn").forEach(btn => {
      btn.onclick = async () => {
        await deleteDoc(doc(db, "resources", btn.dataset.id));
        await logActivity(admin.uid, "Deleted resource", btn.dataset.id, "admin");
      };
    });

    document.querySelectorAll(".edit-res-btn").forEach(btn => {
      btn.onclick = async () => {
        const newTitle = prompt("New title:");
        if (!newTitle) return;

        await updateDoc(doc(db, "resources", btn.dataset.id), { title: newTitle });
        await logActivity(admin.uid, "Edited resource", btn.dataset.id, "admin");
      };
    });
  });
}


// ---------------- Add Resource ----------------
onAuthStateChanged(auth, admin => {
  if (!admin) return;

  document.getElementById("add-resource-btn").onclick = async () => {
    const title = document.getElementById("resource-title").value.trim();
    const file = document.getElementById("resource-file").files[0];

    if (!title || !file) {
      alert("Provide title and file.");
      return;
    }

    try {
      const fileRef = storageRef(storage, `resources/${Date.now()}_${file.name}`);
      await uploadBytes(fileRef, file);
      const url = await getDownloadURL(fileRef);

      await addDoc(collection(db, "resources"), {
        title,
        fileUrl: url,
        uploadedBy: admin.uid,
        uploadedByEmail: admin.email,
        timestamp: serverTimestamp()
      });

      await logActivity(admin.uid, "Added resource", title, "admin");
      alert("Resource added.");

    } catch (err) {
      console.error(err);
      alert("Failed to upload resource.");
    }
  };
});


// ---------------- Load Reports ----------------
function loadReports() {
  const list = document.getElementById("reports-list");
  const q = query(collection(db, "reports"), orderBy("timestamp", "desc"));

  onSnapshot(q, snapshot => {
    list.innerHTML = "";

    snapshot.forEach(docSnap => {
      const report = docSnap.data();
      const id = docSnap.id;

      const li = document.createElement("li");
      li.innerHTML = `
        <div class="report-card">
          <h4>${report.type?.toUpperCase()}</h4>
          <p><strong>Name:</strong> ${report.userName}</p>
          <p><strong>Email:</strong> ${report.userEmail}</p>
          <p><strong>Description:</strong> ${report.description}</p>
          <p><strong>Status:</strong> ${report.status}</p>
          <button class="mark-reviewed-btn" data-id="${id}">Mark Reviewed</button>
        </div>
      `;

      list.appendChild(li);
    });

    onAuthStateChanged(auth, admin => {
      if (!admin) return;

      document.querySelectorAll(".mark-reviewed-btn").forEach(btn => {
        btn.onclick = async () => {
          await updateDoc(doc(db, "reports", btn.dataset.id), {
            status: "reviewed"
          });
          alert("Report reviewed.");
        };
      });
    });
  });
}


// ---------------- Dashboard Stats ----------------
function loadDashboardStats() {
  onSnapshot(collection(db, "users"), snap => {
    document.getElementById("total-users").textContent = snap.size;
  });

  onSnapshot(collection(db, "reports"), snap => {
    document.getElementById("total-reports").textContent = snap.size;
  });

  onSnapshot(collection(db, "appointments"), snap => {
    document.getElementById("total-appointments").textContent = snap.size;
  });
}


// ===================== CHAT SYSTEM =====================
let currentChatId = null;
let currentRecipient = null;
let chatMessagesListener = null;
let chatRoomsListener = null;

async function getOrCreateChatRoom(userId, userName) {
  try {
    const participants = [currentUser.uid, userId].sort();
    const chatRoomId = participants.join('_');
    const chatRoomRef = doc(db, 'chatRooms', chatRoomId);
    const chatRoomSnap = await getDoc(chatRoomRef);
    
    if (chatRoomSnap.exists()) {
      console.log('Found existing chat room:', chatRoomId);
      return { id: chatRoomSnap.id, ...chatRoomSnap.data() };
    } else {
      console.log('Creating new chat room:', chatRoomId);
      const chatRoomData = {
        participants: {
          [currentUser.uid]: `${currentUserData.fullname || currentUserData.email} (${currentUserData.role})`,
          [userId]: userName
        },
        participantIds: participants,
        lastMessage: '',
        lastMessageTime: serverTimestamp(),
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      };
      await setDoc(chatRoomRef, chatRoomData);
      console.log('Chat room created successfully');
      return { id: chatRoomId, ...chatRoomData };
    }
  } catch (err) {
    console.error('Error creating/getting chat room:', err);
    throw err;
  }
}

async function loadUsersForChat() {
  try {
    // Query ALL users except current user
    const usersQuery = query(collection(db, 'users'));
    const snapshot = await getDocs(usersQuery);
    const select = document.getElementById('new-chat-select');
    
    if (!select) {
      console.error('Chat select element not found!');
      return;
    }
    
    select.innerHTML = '<option value="" disabled selected>Start new chat...</option>';
    
    if (snapshot.empty) {
      select.innerHTML += '<option value="" disabled>No users available</option>';
      return;
    }
    
    // Filter out current user
    const otherUsers = [];
    snapshot.forEach(doc => {
      if (doc.id !== currentUser.uid) {
        const userData = doc.data();
        otherUsers.push({
          id: doc.id,
          name: userData.fullname || userData.email || 'Unknown User',
          role: userData.role || 'user',
          email: userData.email || 'No email'
        });
      }
    });
    
    if (otherUsers.length === 0) {
      select.innerHTML += '<option value="" disabled>No other users available</option>';
      return;
    }
    
    // Sort by name
    otherUsers.sort((a, b) => a.name.localeCompare(b.name));
    
    // Add options
    otherUsers.forEach(user => {
      const option = document.createElement('option');
      option.value = user.id;
      option.textContent = `${user.name} (${user.role})`;
      option.dataset.name = `${user.name} (${user.role})`;
      select.appendChild(option);
    });
    
    // Add event listener for new chat selection
    select.addEventListener('change', async e => {
      if (e.target.value) {
        const userId = e.target.value;
        const userName = e.target.selectedOptions[0].dataset.name;
        console.log('Starting new chat with', userName);
        await startNewChat(userId, userName);
        e.target.value = '';
      }
    });
    
  } catch (err) {
    console.error('Error loading users for chat:', err);
  }
}

async function startNewChat(userId, userName) {
  try {
    const chatRoom = await getOrCreateChatRoom(userId, userName);
    console.log('Chat room created/retrieved:', chatRoom.id);
    openChat(chatRoom.id, userId, userName);
    await logActivity(currentUser.uid, 'Started new chat with user', userName, 'admin');
  } catch (err) {
    console.error('Error starting new chat:', err);
    alert(`Error starting chat: ${err.message}`);
  }
}

function loadChatRooms() {
  if (chatRoomsListener) chatRoomsListener();
  
  const q = query(collection(db, 'chatRooms'));
  chatRoomsListener = onSnapshot(q, snapshot => {
    const chatList = document.getElementById('chat-list');
    if (!chatList) return;
    
    if (snapshot.empty) {
      chatList.innerHTML = '<div class="empty-chat-state">No chats yet. Start a new chat!</div>';
      return;
    }
    
    const chatRooms = [];
    snapshot.forEach(doc => {
      const chatData = doc.data();
      if (chatData.participants && chatData.participants[currentUser.uid]) {
        chatRooms.push({ id: doc.id, ...chatData });
      }
    });
    
    if (chatRooms.length === 0) {
      chatList.innerHTML = '<div class="empty-chat-state">No chats yet. Start a new chat!</div>';
      return;
    }
    
    // Sort by last message time
    chatRooms.sort((a, b) => {
      const timeA = a.lastMessageTime?.toDate?.() || new Date(a.lastMessageTime);
      const timeB = b.lastMessageTime?.toDate?.() || new Date(b.lastMessageTime);
      return timeB - timeA;
    });
    
    chatList.innerHTML = '';
    chatRooms.forEach(chat => {
      const chatItem = createChatListItem(chat.id, chat);
      chatList.appendChild(chatItem);
    });
    
    // Highlight current chat
    if (currentChatId) {
      document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.chatId === currentChatId) item.classList.add('active');
      });
    }
  }, error => console.error('Error loading chat rooms:', error));
}

function createChatListItem(chatId, chatData) {
  const div = document.createElement('div');
  div.className = 'chat-item';
  div.dataset.chatId = chatId;
  
  // Find other participant
  let otherParticipantId = null;
  let otherParticipantName = 'Unknown';
  let otherParticipantRole = 'user';
  
  for (const [participantId, participantName] of Object.entries(chatData.participants)) {
    if (participantId !== currentUser.uid) {
      otherParticipantId = participantId;
      otherParticipantName = participantName;
      break;
    }
  }
  
  div.dataset.recipientId = otherParticipantId;
  div.dataset.recipientName = otherParticipantName;
  
  // Extract role from participant name
  const roleMatch = otherParticipantName.match(/\((.*?)\)/);
  if (roleMatch) {
    otherParticipantRole = roleMatch[1].toLowerCase();
  }
  
  const lastMessageTime = chatData.lastMessageTime?.toDate?.() || new Date(chatData.lastMessageTime) || Date.now();
  const timeStr = formatMessageTime(lastMessageTime);
  
  // Create tag based on role
  let tagHtml = '';
  if (otherParticipantRole.includes('survivor') || otherParticipantRole.includes('anonymous')) {
    tagHtml = '<span class="user-tag survivor">(survivor)</span>';
  } else if (otherParticipantRole.includes('medical')) {
    tagHtml = '<span class="user-tag medical">(medical)</span>';
  } else if (otherParticipantRole.includes('therapist')) {
    tagHtml = '<span class="user-tag therapist">(therapist)</span>';
  } else if (otherParticipantRole.includes('legal')) {
    tagHtml = '<span class="user-tag legal">(legal)</span>';
  } else if (otherParticipantRole.includes('admin')) {
    tagHtml = '<span class="user-tag admin">(admin)</span>';
  }
  
  // Remove role from name for display
  const displayName = otherParticipantName.replace(/\(.*?\)/g, '').trim();
  
  div.innerHTML = `
    <div class="chat-item-header">
      <span class="chat-name">${displayName}</span>
      ${tagHtml}
      <span class="chat-time">${timeStr}</span>
    </div>
    <div class="chat-preview">${chatData.lastMessage || 'No messages yet'}</div>
  `;
  
  div.addEventListener('click', () => openChat(chatId, otherParticipantId, otherParticipantName));
  return div;
}

function formatMessageTime(timestamp) {
  const now = new Date();
  const messageDate = new Date(timestamp);
  const diffMs = now - messageDate;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);
  
  if (diffMins < 1) return 'Just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  return messageDate.toLocaleDateString();
}

function openChat(chatId, recipientId, recipientName) {
  console.log('Opening chat:', chatId, 'with', recipientName);
  currentChatId = chatId;
  currentRecipient = { id: recipientId, name: recipientName };
  
  // Update UI
  const chatHeader = document.getElementById('chat-header');
  const chatInputArea = document.getElementById('chat-input-area');
  const chatMessages = document.getElementById('chat-messages');
  
  if (chatHeader) chatHeader.style.display = 'flex';
  if (chatInputArea) chatInputArea.style.display = 'flex';
  if (chatMessages) chatMessages.innerHTML = '';
  
  // Update recipient info
  const recipientNameEl = document.getElementById('recipient-name');
  const recipientAvatar = document.getElementById('recipient-avatar');
  const recipientStatus = document.getElementById('recipient-status');
  
  if (recipientNameEl) recipientNameEl.textContent = recipientName;
  if (recipientAvatar) recipientAvatar.textContent = recipientName.charAt(0).toUpperCase();
  if (recipientStatus) recipientStatus.textContent = 'Online';
  
  // Highlight active chat
  document.querySelectorAll('.chat-item').forEach(item => {
    item.classList.remove('active');
    if (item.dataset.chatId === chatId) item.classList.add('active');
  });
  
  // Remove empty state
  const emptyChat = document.querySelector('.empty-chat');
  if (emptyChat) emptyChat.style.display = 'none';
  
  // Load messages
  loadChatMessages(chatId);
}

function loadChatMessages(chatId) {
  if (chatMessagesListener) chatMessagesListener();
  
  console.log('Loading messages for chat:', chatId);
  const messagesRef = collection(db, 'chatRooms', chatId, 'messages');
  const q = query(messagesRef, orderBy('timestamp', 'asc'));
  
  chatMessagesListener = onSnapshot(q, snapshot => {
    const messagesContainer = document.getElementById('chat-messages');
    if (!messagesContainer) return;
    
    messagesContainer.innerHTML = '';
    
    if (snapshot.empty) {
      messagesContainer.innerHTML = '<div class="empty-chat-state"><p>No messages yet. Start the conversation!</p></div>';
      return;
    }
    
    console.log(`Found ${snapshot.size} messages`);
    snapshot.forEach(doc => {
      const message = doc.data();
      const messageElement = createMessageElement(message);
      messagesContainer.appendChild(messageElement);
    });
    
    // Scroll to bottom
    setTimeout(() => {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }, 100);
  }, error => {
    console.error('Error loading messages:', error);
    const messagesContainer = document.getElementById('chat-messages');
    if (messagesContainer) {
      messagesContainer.innerHTML = '<div class="empty-chat-state"><p>Error loading messages. Please try again.</p></div>';
    }
  });
}

function createMessageElement(message) {
  const div = document.createElement('div');
  const isSent = message.senderId === currentUser.uid;
  const messageTime = message.timestamp?.toDate?.() || new Date(message.timestamp);
  const timeStr = messageTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
  
  div.className = `message ${isSent ? 'sent' : 'received'}`;
  div.innerHTML = `
    <div class="message-content">${message.text}</div>
    <div class="message-time">${timeStr}</div>
  `;
  return div;
}

async function sendMessage() {
  const input = document.getElementById('chat-message-input');
  if (!input) {
    console.error('Chat input not found');
    return;
  }
  
  const text = input.value.trim();
  
  if (!text || !currentChatId || !currentRecipient) {
    console.log('Cannot send: missing text, chatId, or recipient');
    console.log('Text:', text, 'Chat ID:', currentChatId, 'Recipient:', currentRecipient);
    return;
  }
  
  console.log('Sending message:', text);
  console.log('Chat ID:', currentChatId, 'Recipient:', currentRecipient);
  
  try {
    // Create message
    const messageData = {
      text,
      senderId: currentUser.uid,
      senderName: currentUserData.fullname || currentUserData.email,
      senderRole: currentUserData.role || 'admin',
      recipientId: currentRecipient.id,
      recipientName: currentRecipient.name,
      timestamp: serverTimestamp(),
      read: false
    };
    
    console.log('Adding message to Firestore...');
    
    // Add message to subcollection
    await addDoc(collection(db, 'chatRooms', currentChatId, 'messages'), messageData);
    
    // Update chat room last message
    await updateDoc(doc(db, 'chatRooms', currentChatId), {
      lastMessage: text.length > 50 ? text.substring(0, 50) + '...' : text,
      lastMessageTime: serverTimestamp(),
      updatedAt: serverTimestamp()
    });
    
    // Clear input
    input.value = '';
    input.style.height = 'auto';
    
    // Update send button state
    const sendBtn = document.getElementById('send-message-btn');
    if (sendBtn) sendBtn.disabled = true;
    
    // Log activity
    await logActivity(currentUser.uid, 'Sent message to user', currentRecipient.name, 'admin');
    console.log('Message sent successfully');
    
  } catch (err) {
    console.error('Error sending message:', err);
    console.error('Error details:', err.code, err.message);
    alert(`Error: ${err.message}. Check browser console for details.`);
  }
}

function initChat() {
  console.log('Initializing chat for admin...');
  
  if (!currentUser || !currentUser.uid) {
    console.log('No user logged in, skipping chat initialization');
    return;
  }
  
  console.log('Admin is logged in, loading chat...');
  
  // Load ALL users
  loadUsersForChat();
  loadChatRooms();
  
  // Message input handling
  const messageInput = document.getElementById('chat-message-input');
  const sendBtn = document.getElementById('send-message-btn');
  
  if (!messageInput || !sendBtn) {
    console.error('Chat elements not found!');
    return;
  }
  
  messageInput.addEventListener('input', function() {
    // Auto-resize textarea
    this.style.height = 'auto';
    this.style.height = this.scrollHeight + 'px';
    
    // Enable/disable send button
    sendBtn.disabled = !this.value.trim();
  });
  
  messageInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      if (!sendBtn.disabled) sendMessage();
    }
  });
  
  sendBtn.addEventListener('click', sendMessage);
  
  console.log('Chat initialized for admin');
}


// ---------------- Initialize ----------------
onAuthStateChanged(auth, async user => {
  if (!user) return (window.location.href = "../auth/login.html");
  currentUser = user;
  const admin = await loadAdmin(user);
  if (!admin) return;

  loadUsersRealtime();
  loadActivityLogs();
  loadFlaggedMessages();
  loadResources();
  loadReports();
  loadDashboardStats();
  initChat(); // Initialize chat system
});
</script>


</body>
</html>
