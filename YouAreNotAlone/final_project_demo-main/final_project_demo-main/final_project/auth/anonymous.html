<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Anonymous Signup | You Are Not Alone</title>
  <link rel="stylesheet" href="auth.css" />
</head>
<body class="auth-body">

  <div class="auth-container">
    <img src="logo.png" alt="Heart Logo" class="auth-logo" />
    <h1>You Are Not Alone</h1>
    <p class="subtitle">Sign up anonymously for support and resources</p>

    <form id="anonForm">
  <input id="nickname" type="text" placeholder="Nickname" required />
  <input id="password" type="password" placeholder="Password" required />
  <button type="submit">Create Anonymous Account</button>
</form>


    <p class="signup-link">Prefer full signup? <a href="register.html">Register here</a></p>
    <p class="crisis">Crisis Support: 1-800-656-4673</p>
  </div>
  
<script type="module">
import { auth, db } from "../firebase.js";
import { onAuthStateChanged, signOut } 
  from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getDoc, doc } 
  from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

function enforceRole(allowedRoles) {
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "../auth/login.html";
      return;
    }

    const snap = await getDoc(doc(db, "users", user.uid));
    if (!snap.exists()) {
      alert("Profile not found");
      signOut(auth);
      window.location.href = "../auth/login.html";
      return;
    }

    const data = snap.data();

    // Convert roles to array if needed
    const allowed = Array.isArray(allowedRoles) ? allowedRoles : [allowedRoles];

    // â— Enforce allowed roles
    
    if (!allowed.includes(data.role)) {
      alert("Unauthorized access. Redirecting to your dashboard.");
      redirectToCorrectDashboard(data.role);
      return;
    }

    // If authorized, populate UI
    document.querySelector(".user-name").textContent = data.fullname;
    document.querySelector(".user-email").textContent = data.email;
  });
}

function redirectToCorrectDashboard(role) {
  switch (role) {
    case "survivor":
    case "anonymous":
      window.location.href = "../survivor/survivor.html";
      break;
    case "medical":
      window.location.href = "../medical/medical.html";
      break;
    case "legal":
      window.location.href = "../legal/legal.html";
      break;
    case "admin":
      window.location.href = "../admin/admin.html";
      break;
    default:
      window.location.href = "../auth/login.html";
  }
}

// SIGN OUT
document.querySelector(".signout-btn").addEventListener("click", () => {
  signOut(auth).then(() => {
    window.location.href = "../auth/login.html";
  });
});


</script>


</body>
</html>
