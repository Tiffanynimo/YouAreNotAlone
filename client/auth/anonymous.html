<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Anonymous Access | You Are Not Alone</title>
  <link rel="stylesheet" href="auth.css" />
  <style>
    .tabs {
      display: flex;
      margin-bottom: 1.5rem;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid #B68597;
    }
    .tab-btn {
      flex: 1;
      padding: 0.6rem;
      border: none;
      background: white;
      color: #B68597;
      font-size: 0.95rem;
      cursor: pointer;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-weight: 600;
      transition: 0.2s;
    }
    .tab-btn.active { background: #B68597; color: white; }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
    .error-msg {
      color: #c0392b;
      background: #fdecea;
      border-radius: 5px;
      padding: 0.6rem 0.8rem;
      font-size: 0.9rem;
      margin-top: 0.5rem;
      display: none;
    }
    .success-msg {
      color: #27ae60;
      background: #eafaf1;
      border-radius: 5px;
      padding: 0.6rem 0.8rem;
      font-size: 0.9rem;
      margin-top: 0.5rem;
      display: none;
    }
    button:disabled { opacity: 0.7; cursor: not-allowed; }
  </style>
</head>
<body class="auth-body">

  <div class="auth-container">
    <img src="logo.png" alt="Heart Logo" class="auth-logo" />
    <h1>You Are Not Alone</h1>
    <p class="subtitle">Anonymous access — no email needed</p>

    <div class="tabs">
      <button class="tab-btn active" id="tab-signup">Sign Up</button>
      <button class="tab-btn" id="tab-login">Log In</button>
    </div>

    <!-- Sign Up Panel -->
    <div class="tab-panel active" id="panel-signup">
      <form id="anonSignupForm">
        <input id="signup-nickname" type="text" placeholder="Choose a nickname" autocomplete="username" required maxlength="30" />
        <input id="signup-password" type="password" placeholder="Choose a password" autocomplete="new-password" required />
        <div class="error-msg" id="signup-error"></div>
        <div class="success-msg" id="signup-success"></div>
        <button type="submit" id="signup-btn">Create Anonymous Account</button>
      </form>
    </div>

    <!-- Log In Panel -->
    <div class="tab-panel" id="panel-login">
      <form id="anonLoginForm">
        <input id="login-nickname" type="text" placeholder="Your nickname" autocomplete="username" required />
        <input id="login-password" type="password" placeholder="Your password" autocomplete="current-password" required />
        <div class="error-msg" id="login-error"></div>
        <button type="submit" id="login-btn">Log In</button>
      </form>
    </div>

    <p class="signup-link">Prefer full signup? <a href="register.html">Register here</a></p>
    <p class="crisis">Crisis Support: 1-800-656-4673</p>
  </div>

<script type="module">
import { signUp, signIn, redirectToDashboard } from "../lib/auth-client.js";

// ── Tab switching ──────────────────────────────────────────────────
document.getElementById("tab-signup").addEventListener("click", () => switchTab("signup"));
document.getElementById("tab-login").addEventListener("click", () => switchTab("login"));

function switchTab(tab) {
  document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
  document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));
  document.getElementById("tab-" + tab).classList.add("active");
  document.getElementById("panel-" + tab).classList.add("active");
}

// Build a consistent email from nickname so same user can always log back in
function nicknameToEmail(nickname) {
  return `anon_${nickname.trim().toLowerCase().replace(/\s+/g, "_")}@anonymous.local`;
}

function showError(id, msg) {
  const el = document.getElementById(id);
  el.textContent = msg;
  el.style.display = "block";
}
function hideMsg(id) {
  document.getElementById(id).style.display = "none";
}

// ── Anonymous Sign Up ──────────────────────────────────────────────
document.getElementById("anonSignupForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  hideMsg("signup-error");
  hideMsg("signup-success");

  const nickname = document.getElementById("signup-nickname").value.trim();
  const password = document.getElementById("signup-password").value;
  const btn = document.getElementById("signup-btn");

  if (!nickname) return showError("signup-error", "Please enter a nickname.");
  if (password.length < 6) return showError("signup-error", "Password must be at least 6 characters.");

  btn.disabled = true;
  btn.textContent = "Creating account...";

  const anonEmail = nicknameToEmail(nickname);

  try {
    const { data, error } = await signUp({
      email: anonEmail,
      password,
      name: nickname,
      fullname: nickname,
      role: "anonymous",
    });

    if (error) {
      if (error.message?.toLowerCase().includes("already")) {
        showError("signup-error", `The nickname "${nickname}" is already taken. Try a different one or log in instead.`);
      } else {
        showError("signup-error", error.message || "Signup failed. Please try again.");
      }
      return;
    }

    document.getElementById("signup-success").textContent = "Account created! Taking you to your dashboard...";
    document.getElementById("signup-success").style.display = "block";
    setTimeout(() => redirectToDashboard("anonymous"), 1000);
  } catch (err) {
    showError("signup-error", err.message?.includes("fetch") ? "Cannot reach the server. Make sure it is running." : "Something went wrong: " + err.message);
  } finally {
    btn.disabled = false;
    btn.textContent = "Create Anonymous Account";
  }
});

// ── Anonymous Log In ───────────────────────────────────────────────
document.getElementById("anonLoginForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  hideMsg("login-error");

  const nickname = document.getElementById("login-nickname").value.trim();
  const password = document.getElementById("login-password").value;
  const btn = document.getElementById("login-btn");

  if (!nickname) return showError("login-error", "Please enter your nickname.");

  btn.disabled = true;
  btn.textContent = "Logging in...";

  const anonEmail = nicknameToEmail(nickname);

  try {
    const { data, error } = await signIn({ email: anonEmail, password });

    if (error) {
      showError("login-error", "Incorrect nickname or password. Please try again.");
      return;
    }

    redirectToDashboard(data.user.role || "anonymous");
  } catch (err) {
    showError("login-error", err.message?.includes("fetch") ? "Cannot reach the server. Make sure it is running." : "Something went wrong: " + err.message);
  } finally {
    btn.disabled = false;
    btn.textContent = "Log In";
  }
});
</script>

</body>
</html>
