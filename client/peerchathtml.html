<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Support Chatroom | You Are Not Alone</title>

<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #B68597, #DAB6C2, #F2E6EA);
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
  }

  /* â”€â”€ Join screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #nickname-screen {
    background: #F2E6EA;
    border-radius: 20px;
    padding: 40px;
    text-align: center;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    width: 340px;
  }
  #nickname-screen h2 { color: #B68597; margin-bottom: 12px; }
  #nickname-screen p  { color: #666; font-size: 0.9rem; margin-bottom: 20px; }
  #nickname-screen input {
    width: 100%; padding: 12px; border-radius: 10px;
    border: 1px solid #DAB6C2; background: #DAB6C2;
    margin-bottom: 15px; font-size: 1rem;
  }
  #nickname-screen button {
    background: #B68597; border: none; padding: 12px 24px;
    border-radius: 12px; cursor: pointer; color: white;
    font-weight: bold; font-size: 1rem; width: 100%; transition: 0.3s;
  }
  #nickname-screen button:hover { background: #9C6C7F; }
  #join-error {
    color: #c0392b; background: #fdecea; border-radius: 8px;
    padding: 8px 12px; font-size: 0.85rem; margin-top: 10px; display: none;
  }

  /* â”€â”€ Main chat layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .chat-wrapper { display: none; width: 95%; height: 92vh; background: #DAB6C2; border-radius: 20px; overflow: hidden; box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
  .chat-wrapper.visible { display: flex; }

  /* Sidebar */
  .user-list {
    width: 220px; flex-shrink: 0; background: #F2E6EA;
    padding: 16px; border-right: 3px solid #B68597;
    overflow-y: auto; display: flex; flex-direction: column; gap: 0;
  }
  .user-list h2 { color: #B68597; margin-bottom: 6px; font-size: 1rem; }
  .online-count { font-size: 0.78rem; color: #888; margin-bottom: 10px; }

  .user-item {
    padding: 10px 12px; background: #C79DAA; border-radius: 10px;
    margin-bottom: 8px; cursor: pointer; transition: 0.2s;
    display: flex; align-items: center; gap: 8px; font-size: 0.9rem;
  }
  .user-item:hover, .user-item.active { background: #B68597; color: white; }
  .user-item .dot { width: 8px; height: 8px; background: #4caf50; border-radius: 50%; flex-shrink: 0; }
  .user-item.me { font-style: italic; cursor: default; }

  /* Chat area */
  .chat-area { flex: 1; display: flex; flex-direction: column; padding: 16px; min-width: 0; }
  .chat-title { font-weight: bold; color: #7a3e52; margin-bottom: 8px; font-size: 1rem; }

  .messages {
    flex: 1; overflow-y: auto; background: #F2E6EA;
    padding: 16px; border-radius: 15px;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.08);
    scroll-behavior: smooth;
  }

  .bubble {
    margin: 8px 0; background: #C79DAA; padding: 10px 14px;
    border-radius: 14px; max-width: 72%; word-wrap: break-word;
  }
  .bubble.self { background: #B68597; color: white; margin-left: auto; }
  .bubble .sender { font-size: 0.72rem; font-weight: bold; color: #7a3e52; margin-bottom: 4px; }
  .bubble.self .sender { color: #f8d7e1; }
  .timestamp { display: block; font-size: 0.68rem; color: #6b6b6b; margin-top: 4px; text-align: right; }
  .bubble.self .timestamp { color: #f0ccd6; }

  .system-msg { text-align: center; font-size: 0.78rem; color: #888; margin: 6px 0; font-style: italic; }

  /* Input bar */
  .input-bar { display: flex; margin-top: 12px; gap: 8px; }
  .input-bar input {
    flex: 1; padding: 11px 14px; border-radius: 12px; border: none;
    background: #fff; font-size: 0.95rem; outline: none;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  }
  .input-bar button {
    background: #B68597; border: none; padding: 11px 18px;
    border-radius: 12px; cursor: pointer; color: white;
    font-weight: bold; transition: 0.2s; white-space: nowrap;
  }
  .input-bar button:hover { background: #9C6C7F; }
  .input-bar button:disabled { opacity: 0.5; cursor: not-allowed; }

  /* Private popup */
  .private-popup {
    position: fixed; bottom: 20px; right: 20px; width: 310px;
    background: #F2E6EA; border-radius: 16px;
    box-shadow: 0 6px 24px rgba(0,0,0,0.2);
    display: none; flex-direction: column; z-index: 1000;
  }
  .private-popup.open { display: flex; }
  .private-header {
    padding: 12px 16px; background: #B68597; color: white;
    border-radius: 16px 16px 0 0; font-weight: bold;
    display: flex; justify-content: space-between; align-items: center;
  }
  .close-btn {
    cursor: pointer; padding: 3px 9px; border-radius: 7px;
    background: rgba(255,255,255,0.25); user-select: none;
  }
  .private-messages { height: 220px; padding: 10px; overflow-y: auto; scroll-behavior: smooth; }
  .private-input { display: flex; padding: 10px; gap: 6px; }
  .private-input input {
    flex: 1; padding: 8px 12px; border-radius: 10px;
    border: none; background: #DAB6C2; font-size: 0.9rem;
  }
  .private-input button {
    padding: 8px 13px; background: #B68597; border: none;
    color: white; border-radius: 10px; cursor: pointer; font-weight: bold;
  }
  .private-input button:disabled { opacity: 0.5; cursor: not-allowed; }

  /* Loading state */
  .loading-history { text-align: center; color: #aaa; font-size: 0.82rem; padding: 12px; }
</style>
</head>
<body>

<!-- Join screen -->
<div id="nickname-screen">
  <h2>Support Chatroom</h2>
  <p>You are safe here. Join the peer support chat.</p>
  <input id="nickname-input" type="text" placeholder="Your nickname (e.g. Hope)" maxlength="30" />
  <button id="join-btn">Join Chat</button>
  <div id="join-error"></div>
</div>

<!-- Main chat -->
<div class="chat-wrapper" id="chat-wrapper">
  <div class="user-list">
    <h2>Online</h2>
    <div class="online-count" id="online-count">0 online</div>
    <div id="user-list-items"></div>
  </div>

  <div class="chat-area">
    <div class="chat-title" id="chat-title">Public Room</div>
    <div class="messages" id="publicMessages"></div>
    <div class="input-bar">
      <input id="publicInput" placeholder="Type a message to everyone..." />
      <button id="sendPublicBtn">Send</button>
    </div>
  </div>
</div>

<!-- Private chat popup -->
<div class="private-popup" id="privatePopup">
  <div class="private-header">
    <span id="privateChatTitle">Private Chat</span>
    <span class="close-btn" id="closePrivateBtn">âœ•</span>
  </div>
  <div class="private-messages" id="privateMessages"></div>
  <div class="private-input">
    <input id="privateInput" placeholder="Message..." />
    <button id="sendPrivateBtn">Send</button>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();

  let myNickname = "";
  let myUserId = null;
  let privateChatTarget = null;

  function formatTime(isoString) {
    return new Date(isoString).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  function makeBubble({ nickname, text, timestamp, isSelf, container }) {
    const box = document.createElement("div");
    box.className = "bubble" + (isSelf ? " self" : "");
    box.innerHTML = `
      <div class="sender">${isSelf ? "You" : nickname}</div>
      ${escapeHtml(text)}
      <span class="timestamp">${formatTime(timestamp)}</span>
    `;
    container.appendChild(box);
  }

  function escapeHtml(str) {
    return str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }

  function scrollBottom(el) {
    el.scrollTop = el.scrollHeight;
  }

  // â”€â”€ Auto-fill nickname from session â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  (async function tryAutoJoin() {
    try {
      const res = await fetch('/api/auth/get-session', { credentials: 'include' });
      const data = await res.json();
      if (data && data.user) {
        myUserId = data.user.id || null;
        const nickname = data.user.fullname || data.user.name || '';
        if (nickname) {
          document.getElementById("nickname-input").value = nickname;
          joinChat();
        }
      }
    } catch (e) {
      // No session â€” user enters nickname manually
    }
  })();

  // â”€â”€ Join â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById("join-btn").addEventListener("click", joinChat);
  document.getElementById("nickname-input").addEventListener("keydown", e => {
    if (e.key === "Enter") joinChat();
  });

  async function joinChat() {
    const val = document.getElementById("nickname-input").value.trim();
    if (!val) return;
    myNickname = val;

    document.getElementById("nickname-screen").style.display = "none";
    document.getElementById("chat-wrapper").classList.add("visible");

    socket.emit("join", { id: myUserId, nickname: myNickname });

    // Load public chat history from DB
    const pubMsgs = document.getElementById("publicMessages");
    pubMsgs.innerHTML = '<div class="loading-history">Loading chat history...</div>';

    try {
      const history = await fetch('/api/peer-chat/public').then(r => r.json());
      pubMsgs.innerHTML = '';
      if (history.length > 0) {
        addSystemMessage(`â€” ${history.length} previous messages â€”`);
        history.forEach(msg => {
          makeBubble({
            nickname: msg.sender_nickname,
            text: msg.text,
            timestamp: msg.created_at,
            isSelf: msg.sender_nickname === myNickname,
            container: pubMsgs,
          });
        });
      }
    } catch (e) {
      pubMsgs.innerHTML = '';
    }

    addSystemMessage(`You joined as <strong>${myNickname}</strong>`);
    scrollBottom(pubMsgs);
  }

  // â”€â”€ Online users list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  socket.on("online-users", (users) => {
    const container = document.getElementById("user-list-items");
    const countEl   = document.getElementById("online-count");
    countEl.textContent = `${users.length} online`;
    container.innerHTML = "";

    users.forEach(u => {
      const div = document.createElement("div");
      const isMe = u.nickname === myNickname;
      div.className = "user-item" + (isMe ? " me" : "") + (u.nickname === privateChatTarget ? " active" : "");
      div.innerHTML = `<span class="dot"></span>${escapeHtml(u.nickname)}${isMe ? ' (you)' : ''}`;
      if (!isMe) {
        div.title = `Click to private message ${u.nickname}`;
        div.addEventListener("click", () => openPrivateChat(u.nickname));
      }
      container.appendChild(div);
    });
  });

  // â”€â”€ Public chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById("sendPublicBtn").addEventListener("click", sendPublic);
  document.getElementById("publicInput").addEventListener("keydown", e => {
    if (e.key === "Enter") sendPublic();
  });

  function sendPublic() {
    const input = document.getElementById("publicInput");
    const text = input.value.trim();
    if (!text || !myNickname) return;
    socket.emit("public-message", { nickname: myNickname, text, userId: myUserId });
    input.value = "";
  }

  socket.on("public-message", ({ nickname, text, timestamp }) => {
    const msgs = document.getElementById("publicMessages");
    makeBubble({ nickname, text, timestamp, isSelf: nickname === myNickname, container: msgs });
    scrollBottom(msgs);
  });

  // â”€â”€ Private chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function openPrivateChat(targetNickname) {
    privateChatTarget = targetNickname;
    document.getElementById("privateChatTitle").textContent = `ðŸ’¬ ${targetNickname}`;
    document.getElementById("privateMessages").innerHTML = '<div class="loading-history">Loading...</div>';
    document.getElementById("privatePopup").classList.add("open");
    document.getElementById("privateInput").focus();

    document.querySelectorAll(".user-item").forEach(el => {
      el.classList.toggle("active", el.textContent.includes(targetNickname));
    });

    // Load DM history from DB
    try {
      const history = await fetch(
        `/api/peer-chat/private?me=${encodeURIComponent(myNickname)}&with=${encodeURIComponent(targetNickname)}`
      ).then(r => r.json());

      const container = document.getElementById("privateMessages");
      container.innerHTML = '';
      history.forEach(msg => {
        makeBubble({
          nickname: msg.sender_nickname,
          text: msg.text,
          timestamp: msg.created_at,
          isSelf: msg.sender_nickname === myNickname,
          container,
        });
      });
      scrollBottom(container);
    } catch (e) {
      document.getElementById("privateMessages").innerHTML = '';
    }
  }

  document.getElementById("closePrivateBtn").addEventListener("click", () => {
    document.getElementById("privatePopup").classList.remove("open");
    privateChatTarget = null;
    document.querySelectorAll(".user-item").forEach(el => el.classList.remove("active"));
  });

  document.getElementById("sendPrivateBtn").addEventListener("click", sendPrivate);
  document.getElementById("privateInput").addEventListener("keydown", e => {
    if (e.key === "Enter") sendPrivate();
  });

  function sendPrivate() {
    const input = document.getElementById("privateInput");
    const text = input.value.trim();
    if (!text || !privateChatTarget || !myNickname) return;
    socket.emit("private-message", {
      toNickname: privateChatTarget,
      fromNickname: myNickname,
      text,
      userId: myUserId,
    });
    input.value = "";
  }

  socket.on("private-message", ({ from, to, text, timestamp, isSelf }) => {
    const container = document.getElementById("privateMessages");

    // If incoming from someone else and popup isn't open for them, open it
    if (!isSelf && from !== myNickname && privateChatTarget !== from) {
      openPrivateChat(from);
      return; // openPrivateChat will load history; incoming will be added separately
    }

    makeBubble({ nickname: from, text, timestamp, isSelf: !!isSelf, container });
    scrollBottom(container);
  });

  // â”€â”€ System messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function addSystemMessage(html) {
    const div = document.createElement("div");
    div.className = "system-msg";
    div.innerHTML = html;
    const msgs = document.getElementById("publicMessages");
    msgs.appendChild(div);
  }
</script>

</body>
</html>
